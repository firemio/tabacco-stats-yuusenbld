# 本番データベース修正パッチ

## 概要

行列終了判定の不具合により、本番データベースに不正な行列イベントが記録されていました。
このパッチは、ステータス履歴から正しい行列イベントを再生成します。

## 問題の詳細

### 修正前の動作
- 行列終了判定: **3人以下**で終了
- サーバー再起動時: 未完了イベントを**強制終了**（不正確な終了時刻）
- 結果: すべての行列イベントが2人以下で終了していない不正なデータ

### 修正後の動作
- 行列終了判定: **2人以下**で終了（ユーザー要求通り）
- サーバー再起動時: 未完了イベントを**削除**（データ整合性を保つ）
- 結果: すべての行列イベントが正しく2人以下で終了

## パッチ適用手順

### 1. ファイルをアップロード

本番サーバーに以下のファイルをアップロードしてください：

```
server/api-scraper.js    # 修正済み
server/database.js       # 修正済み
patch-queue-events.js    # パッチスクリプト
```

### 2. サーバーを停止

```bash
# pm2の場合
pm2 stop tobacco-stats

# または
npm stop
```

### 3. パッチを実行

```bash
node patch-queue-events.js
```

実行内容：
1. 現在の状況を確認
2. 不正な行列イベントを削除
3. ステータス履歴から正しいイベントを再生成
4. データを検証

### 4. サーバーを再起動

```bash
# pm2の場合
pm2 start tobacco-stats

# または
npm start
```

## 実行例

```
========================================
  本番データベース修正パッチ
========================================

【ステップ1】現在の状況を確認

現在の行列イベント数: 523件
不正なイベント数: 523件（2人以下で終了していない）
正常なイベント数: 0件

【ステップ2】既存の行列イベントを削除

✅ 523件の行列イベントを削除しました

【ステップ3】ステータス履歴から行列イベントを再生成

ステータスレコード数: 7050件

【ステップ4】行列検知ロジックを実行

  処理中... 10% (705/7050)
  処理中... 20% (1410/7050)
  ...

✅ 130件の行列イベントを生成しました

【ステップ5】生成されたデータを検証

生成された行列イベント数: 130件
不正なイベント数: 0件
正常なイベント数: 130件

✅ すべての行列イベントが正しく生成されました！
   すべてのイベントが2人以下で終了しています。

========================================
  パッチ適用完了
========================================
削除: 523件
生成: 130件
差分: -393件
```

## 行列検知ロジック（確認）

- **満員**: 6人以上
- **空き**: 3～5人（行列継続中）
- **行列終了**: **2人以下**
- **入れ替わりカウント**: 満員(6+) → 空き(3～5) → 満員(6+) = 1カウント

### 例

シーケンス: `6人 → 4人 → 5人 → 6人 → 3人 → 1人`

1. `6人`: 行列開始（満員）
2. `4人`: 空き（継続中、wasFull=false）
3. `5人`: 空き（継続中）
4. `6人`: 満員（入れ替わり+1、推定待ち1人）
5. `3人`: 空き（継続中）
6. `1人`: **行列終了**（2人以下）

結果: 入れ替わり1回、推定待ち1人

## 注意事項

- パッチは安全に実行できます（既存データは削除されますが、ステータス履歴から再生成されます）
- ステータス履歴（`status_records`テーブル）は削除されません
- 実行前にデータベースのバックアップを推奨します

## バックアップ方法（オプション）

```bash
# SQLiteデータベースをバックアップ
cp tobacco_stats.db tobacco_stats.db.backup_$(date +%Y%m%d_%H%M%S)
```

## トラブルシューティング

### パッチ実行後も不正なイベントがある場合

開発者に連絡してください。以下の情報を提供してください：

```bash
# 不正なイベントの詳細を確認
node -e "import('./server/database.js').then(m => { const db = m.default; const stmt = db.prepare('SELECT id, datetime(end_time / 1000, \"unixepoch\", \"localtime\") as end_time, (SELECT count FROM status_records sr WHERE sr.camera_id = qe.camera_id AND sr.timestamp <= qe.end_time ORDER BY sr.timestamp DESC LIMIT 1) as count_at_end FROM queue_events qe WHERE qe.camera_id = \"abd6ab54-0eb9-4f52-a5a0-df6d8fd1ecb2\" AND qe.end_time IS NOT NULL AND count_at_end > 2 LIMIT 10'); console.log(stmt.all()); })"
```

## 完了後の確認

Webインターフェースで以下を確認してください：

1. 行列履歴が表示される
2. すべての行列が適切な時刻で終了している
3. 統計データが正しく表示される

---

**作成日**: 2025-11-10
**バージョン**: 1.0

